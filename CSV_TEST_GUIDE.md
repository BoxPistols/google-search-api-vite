# CSVエクスポート機能テストガイド

このドキュメントでは、CSV エクスポート機能が Windows と Mac の両方で正しく動作することを確認するためのテスト手順を説明します。

## 実装内容

### 文字化け対策

1. **BOM（Byte Order Mark）の追加**
   - UTF-8 BOM (`\uFEFF`) をファイルの先頭に追加
   - Excel for Windows/Mac で日本語が正しく認識される

2. **改行コードの統一**
   - Windows 互換性のため `\r\n` (CRLF) を使用
   - Mac/Linux でも正しく表示される

3. **特殊文字のエスケープ**
   - セル内の改行を空白に置換
   - ダブルクォートを `""` にエスケープ
   - すべてのセルを `"..."` で囲む

4. **ファイル名の改善**
   - タイムスタンプを含めることで一意性を確保
   - 形式: `search_results_{keyword}_{timestamp}.csv`

## テスト手順

### Windows でのテスト

#### 1. Excel で開く場合

```bash
# 1. アプリケーションで検索を実行
# 2. 「📄 CSV」ボタンをクリック
# 3. ダウンロードされた CSV ファイルを Excel で開く
```

**期待される結果:**
- ✅ 日本語が正しく表示される（文字化けしない）
- ✅ ヘッダー行が正しく表示される（順位、タイトル、URL、説明、表示URL）
- ✅ セル内で改行がなく、データが見やすい
- ✅ URL やタイトルに含まれる特殊文字が正しく表示される

#### 2. メモ帳で開く場合

```bash
# CSV ファイルを右クリック > プログラムから開く > メモ帳
```

**期待される結果:**
- ✅ UTF-8 で保存されている
- ✅ 日本語が正しく表示される
- ✅ 各行が `\r\n` で区切られている

### Mac でのテスト

#### 1. Numbers で開く場合

```bash
# 1. アプリケーションで検索を実行
# 2. 「📄 CSV」ボタンをクリック
# 3. ダウンロードされた CSV ファイルを Numbers で開く
```

**期待される結果:**
- ✅ 日本語が正しく表示される
- ✅ ヘッダー行が正しく表示される
- ✅ データが適切な列に配置される

#### 2. Excel for Mac で開く場合

```bash
# CSV ファイルを Excel for Mac で開く
```

**期待される結果:**
- ✅ 日本語が正しく表示される（文字化けしない）
- ✅ Windows の Excel と同じように表示される

#### 3. テキストエディットで開く場合

```bash
# CSV ファイルを右クリック > このアプリケーションで開く > テキストエディット
```

**期待される結果:**
- ✅ UTF-8 で正しくエンコードされている
- ✅ 日本語が正しく表示される

### Google Sheets でのテスト

```bash
# 1. Google Drive を開く
# 2. CSV ファイルをアップロード
# 3. Google Sheets で開く
```

**期待される結果:**
- ✅ 日本語が正しく表示される
- ✅ データが適切な列に配置される
- ✅ 特殊文字が正しく処理される

## トラブルシューティング

### Windows で文字化けする場合

**問題:** Excel で開いたときに日本語が文字化けする

**解決方法:**
1. CSV ファイルを右クリック > プログラムから開く > メモ帳
2. ファイル > 名前を付けて保存
3. エンコーディングを「UTF-8」に変更して保存
4. Excel で再度開く

または

1. Excel を開く
2. データ > テキストから > CSV ファイルを選択
3. ファイルの元の形式: UTF-8 を選択
4. 区切り文字: カンマを選択
5. 完了

### Mac で文字化けする場合

**問題:** Numbers や Excel for Mac で文字化けする

**解決方法:**
1. ファイルをテキストエディットで開く
2. フォーマット > 標準テキストにする
3. ファイル > 保存
4. Numbers または Excel で再度開く

## テストケース

以下の特殊な文字列を含む検索結果でテストすることを推奨します：

1. **日本語文字:**
   - ひらがな、カタカナ、漢字
   - 例: 「Google検索ランキングチェッカー」

2. **特殊文字:**
   - ダブルクォート (`"`)
   - カンマ (`,`)
   - セミコロン (`;`)

3. **改行を含むテキスト:**
   - 長いスニペット
   - 複数行の説明文

4. **絵文字:**
   - 🔍 📊 📅 などの絵文字

5. **混在した文字列:**
   - 日本語 + 英語 + 数字 + 特殊文字

## 実装コード（参考）

```typescript
// CSV用に文字列をエスケープする関数（Windows/Mac両対応）
const escapeCSVField = (field: string | number): string => {
  const str = String(field);
  // 改行を空白に置換（CSVの可読性向上）
  const cleaned = str.replace(/[\r\n]+/g, ' ').trim();
  // ダブルクォートをエスケープ
  const escaped = cleaned.replace(/"/g, '""');
  return `"${escaped}"`;
};

// BOM（Byte Order Mark）を追加してUTF-8で正しく認識されるようにする
const BOM = '\uFEFF';

// Windows互換性のため改行コードを\r\nに統一
const csvString = BOM + [headerRow, ...dataRows].join('\r\n');

// UTF-8 BOM付きでBlobを作成
const blob = new Blob([csvString], { type: 'text/csv;charset=utf-8;' });
```

## 注意事項

- CSV ファイルは UTF-8 BOM 付きで保存されます
- 改行コードは CRLF (`\r\n`) です
- すべてのフィールドはダブルクォートで囲まれています
- セル内の改行は自動的に空白に変換されます

## サポートされているアプリケーション

### Windows
- ✅ Microsoft Excel 2016 以降
- ✅ LibreOffice Calc
- ✅ Google Sheets
- ✅ Notepad, Notepad++
- ✅ VS Code

### Mac
- ✅ Microsoft Excel for Mac
- ✅ Numbers
- ✅ Google Sheets
- ✅ TextEdit
- ✅ VS Code

### Linux
- ✅ LibreOffice Calc
- ✅ Google Sheets
- ✅ 任意のテキストエディタ

## まとめ

この実装により、Windows と Mac の両方で文字化けせずに CSV ファイルを開くことができます。BOM の追加、改行コードの統一、適切なエスケープ処理により、主要な表計算ソフトウェアとの互換性が確保されています。
